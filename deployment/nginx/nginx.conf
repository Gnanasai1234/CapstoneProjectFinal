events {
    worker_connections 1024;
}

http {
    upstream blue_backend {
        server localhost:5000;
    }

    upstream green_backend {
        server localhost:5001;
    }

    # Map active environment to backend upstream
    map $active_environment $backend_upstream {
        blue    blue_backend;
        green   green_backend;
        default blue_backend;
    }

    # Map active environment to frontend root directory (for static file serving)
    # Note: For non-Docker setups, you may need to adjust these paths
    map $active_environment $frontend_root {
        blue    /path/to/frontend/build-blue;
        green   /path/to/frontend/build-green;
        default /path/to/frontend/build-blue;
    }

    server {
        listen 8080;

        location /health/blue {
            proxy_pass http://blue_backend/health;
            proxy_set_header Host $host;
        }

        location /health/green {
            proxy_pass http://green_backend/health;
            proxy_set_header Host $host;
        }
    }

    server {
        listen 80;
        server_name localhost;

        set $active_environment "blue";

        # For development: proxy to React dev server
        # For production: serve static files (uncomment root directive below)
        # root $frontend_root;
        # index index.html;
        
        location / {
            # Development mode: proxy to React dev server
            proxy_pass http://localhost:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Environment $active_environment;
            
            # Production mode: uncomment below and comment proxy_pass above
            # try_files $uri $uri/ /index.html;
            # add_header X-Environment $active_environment;
        }
        
        # Serve static assets (for production builds)
        # location /static/ {
        #     root $frontend_root;
        #     expires 1y;
        #     add_header Cache-Control "public, immutable";
        # }

        location /api/ {
            proxy_pass http://$backend_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Environment $active_environment;
        }

        location /health {
            proxy_pass http://$backend_upstream;
            proxy_set_header Host $host;
            rewrite ^/health(.*)$ /health$1 break;
        }
    }
}

